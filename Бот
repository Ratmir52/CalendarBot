import logging
from telegram import Update
from telegram.ext import (
    Updater,
    CommandHandler,
    CallbackContext,
    MessageHandler,
    Filters,
    ConversationHandler,
)
from datetime import datetime, timedelta
import sqlite3
import pytz

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è ConversationHandler
DATE, REMINDER, REMINDER_TYPE = range(3)

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite
conn = sqlite3.connect('reminders.db', check_same_thread=False)
cursor = conn.cursor()

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å –Ω–æ–≤—ã–º –ø–æ–ª–µ–º –¥–ª—è —Ç–∏–ø–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
cursor.execute('''
    CREATE TABLE IF NOT EXISTS reminders (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_id INTEGER,
        date TEXT,
        reminder_text TEXT,
        notified INTEGER DEFAULT 0,
        reminder_type TEXT DEFAULT 'once'
    )
''')
conn.commit()

def start(update: Update, context: CallbackContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = update.effective_user
    update.message.reply_text(
        f"–ü—Ä–∏–≤–µ—Ç, {user.first_name}! –Ø –±–æ—Ç –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π /add —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π /list —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–≤–æ–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è."
    )

def add_reminder(update: Update, context: CallbackContext) -> int:
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"""
    update.message.reply_text(
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä: 31.12.2023 23:59"
    )
    return DATE

def date_received(update: Update, context: CallbackContext) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—É—é –¥–∞—Ç—É"""
    user_date = update.message.text
    try:
        # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É
        date_obj = datetime.strptime(user_date, "%d.%m.%Y %H:%M")
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        context.user_data['reminder_date'] = date_obj.strftime("%Y-%m-%d %H:%M")
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        keyboard = [
            ['–û–±—ã—á–Ω–æ–µ (–≤ –¥–µ–Ω—å —Å–æ–±—ã—Ç–∏—è)'],
            ['–° –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –∑–∞ 3 –¥–Ω—è']
        ]
        reply_markup = {'keyboard': keyboard, 'one_time_keyboard': True}
        
        update.message.reply_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:",
            reply_markup=reply_markup
        )
        return REMINDER_TYPE
    except ValueError:
        update.message.reply_text("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        return DATE

def reminder_type_received(update: Update, context: CallbackContext) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Ç–∏–ø–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"""
    reminder_type = update.message.text
    if reminder_type == '–° –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –∑–∞ 3 –¥–Ω—è':
        context.user_data['reminder_type'] = 'with_3day_alert'
    else:
        context.user_data['reminder_type'] = 'once'
    
    update.message.reply_text("–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:")
    return REMINDER

def reminder_received(update: Update, context: CallbackContext) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–≥–æ –≤ –ë–î"""
    reminder_text = update.message.text
    user_id = update.effective_user.id
    date_str = context.user_data['reminder_date']
    reminder_type = context.user_data.get('reminder_type', 'once')
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    cursor.execute(
        "INSERT INTO reminders (user_id, date, reminder_text, reminder_type) VALUES (?, ?, ?, ?)",
        (user_id, date_str, reminder_text, reminder_type)
    )
    conn.commit()
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
    date_obj = datetime.strptime(date_str, "%Y-%m-%d %H:%M")
    formatted_date = date_obj.strftime("%d.%m.%Y %H:%M")
    
    if reminder_type == 'with_3day_alert':
        alert_date = (date_obj - timedelta(days=3)).strftime("%d.%m.%Y %H:%M")
        update.message.reply_text(
            f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞ {formatted_date}!\n"
            f"–í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 3 –¥–Ω—è ({alert_date})"
        )
    else:
        update.message.reply_text(
            f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞ {formatted_date}!"
        )
    
    # –û—á–∏—â–∞–µ–º user_data
    context.user_data.clear()
    return ConversationHandler.END

def cancel(update: Update, context: CallbackContext) -> int:
    """–û—Ç–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"""
    update.message.reply_text("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    context.user_data.clear()
    return ConversationHandler.END

def list_reminders(update: Update, context: CallbackContext) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = update.effective_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    cursor.execute(
        "SELECT id, date, reminder_text, reminder_type FROM reminders WHERE user_id = ? AND notified = 0 ORDER BY date",
        (user_id,)
    )
    reminders = cursor.fetchall()
    
    if not reminders:
        update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π.")
        return
    
    message = "–í–∞—à–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:\n\n"
    for reminder in reminders:
        reminder_id, date_str, text, r_type = reminder
        date_obj = datetime.strptime(date_str, "%Y-%m-%d %H:%M")
        formatted_date = date_obj.strftime("%d.%m.%Y %H:%M")
        
        if r_type == 'with_3day_alert':
            alert_date = (date_obj - timedelta(days=3)).strftime("%d.%m.%Y %H:%M")
            message += f"‚è∞ {formatted_date} (–Ω–∞–ø–æ–º–Ω—é –∑–∞ 3 –¥–Ω—è {alert_date}): {text} [/del_{reminder_id}]\n"
        else:
            message += f"‚è∞ {formatted_date}: {text} [/del_{reminder_id}]\n"
    
    update.message.reply_text(message, parse_mode="Markdown")

def delete_reminder(update: Update, context: CallbackContext) -> None:
    """–£–¥–∞–ª—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ ID"""
    user_id = update.effective_user.id
    command = update.message.text
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–∑ –∫–æ–º–∞–Ω–¥—ã
    try:
        reminder_id = int(command.split('_')[1])
    except (IndexError, ValueError):
        update.message.reply_text("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã.")
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    cursor.execute(
        "SELECT id FROM reminders WHERE id = ? AND user_id = ?",
        (reminder_id, user_id)
    )
    if not cursor.fetchone():
        update.message.reply_text("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤–∞–º.")
        return
    
    # –£–¥–∞–ª—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
    cursor.execute("DELETE FROM reminders WHERE id = ?", (reminder_id,))
    conn.commit()
    
    update.message.reply_text("–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ!")

def check_reminders(context: CallbackContext) -> None:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"""
    now = datetime.now()
    now_str = now.strftime("%Y-%m-%d %H:%M")
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—ã—á–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (–≤ –¥–µ–Ω—å —Å–æ–±—ã—Ç–∏—è)
    cursor.execute(
        "SELECT id, user_id, reminder_text FROM reminders WHERE date <= ? AND notified = 0 AND reminder_type = 'once'",
        (now_str,)
    )
    reminders = cursor.fetchall()
    
    for reminder in reminders:
        reminder_id, user_id, text = reminder
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            context.bot.send_message(
                chat_id=user_id,
                text=f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {text}"
            )
            
            # –ü–æ–º–µ—á–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ
            cursor.execute(
                "UPDATE reminders SET notified = 1 WHERE id = ?",
                (reminder_id,)
            )
            conn.commit()
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {e}")
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –∑–∞ 3 –¥–Ω—è
    three_days_later = now + timedelta(days=3)
    three_days_str = three_days_later.strftime("%Y-%m-%d %H:%M")
    
    cursor.execute(
        '''SELECT id, user_id, date, reminder_text FROM reminders 
           WHERE date <= ? AND notified = 0 AND reminder_type = 'with_3day_alert'
           AND (last_alert_date IS NULL OR last_alert_date < ?)''',
        (three_days_str, now_str)
    )
    alert_reminders = cursor.fetchall()
    
...     for reminder in alert_reminders:
...         reminder_id, user_id, date_str, text = reminder
...         event_date = datetime.strptime(date_str, "%Y-%m-%d %H:%M")
...         days_left = (event_date - now).days
...         
...         try:
...             # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
...             context.bot.send_message(
...                 chat_id=user_id,
...                 text=f"üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ {days_left} –¥–Ω—è: {text}\n"
...                      f"–î–∞—Ç–∞ —Å–æ–±—ã—Ç–∏—è: {event_date.strftime('%d.%m.%Y %H:%M')}"
...             )
...             
...             # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
...             cursor.execute(
...                 "UPDATE reminders SET last_alert_date = ? WHERE id = ?",
...                 (now_str, reminder_id)
...             )
...             conn.commit()
...         except Exception as e:
...             logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è: {e}")
... 
... def main() -> None:
...     """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
...     # –°–æ–∑–¥–∞–µ–º Updater –∏ –ø–µ—Ä–µ–¥–∞–µ–º –µ–º—É —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
...     updater = Updater("8367697399:AAFgsEf9uuRRx_q97e8EbiqPSBBL4UDK5Xc")
...     
...     # –ü–æ–ª—É—á–∞–µ–º –¥–∏—Å–ø–µ—Ç—á–µ—Ä –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
...     dispatcher = updater.dispatcher
...     
...     # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
...     dispatcher.add_handler(CommandHandler("/start", start))
...     
...     # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /list
...     dispatcher.add_handler(CommandHandler("/list", list_reminders))
...     
...     # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã –≤–∏–¥–∞ /del_123
...     dispatcher.add_handler(MessageHandler(Filters.regex(r'^/del_\d+$'), delete_reminder))
...     
...     # ConversationHandler –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
...     conv_handler = ConversationHandler(
...         entry_points=[CommandHandler('add', add_reminder)],
...         states={
...             DATE: [MessageHandler(Filters.text & ~Filters.command, date_received)],
...             REMINDER_TYPE: [MessageHandler(Filters.text & ~Filters.command, reminder_type_received)],
...             REMINDER: [MessageHandler(Filters.text & ~Filters.command, reminder_received)],
...         },
...         fallbacks=[CommandHandler('cancel', cancel)],
...     )
...     dispatcher.add_handler(conv_handler)
...     
...     # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
...     job_queue = updater.job_queue
...     job_queue.run_repeating(check_reminders, interval=60.0, first=0.0)
...     
...     # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
...     updater.start_polling()
...     updater.idle()
... 
... if __name__ == '__main__':

